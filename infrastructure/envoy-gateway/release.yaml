---
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: envoy-gateway
  namespace: flux-system
spec:
  interval: 15m
  url: oci://docker.io/envoyproxy/gateway-helm
  ref:
    tag: "1.6.2"
  layerSelector:
    mediaType: "application/vnd.cncf.helm.chart.content.v1.tar+gzip"
    operation: copy
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: envoy-gateway
  namespace: flux-system
spec:
  releaseName: envoy-gateway
  targetNamespace: envoy-gateway
  interval: 10m
  chartRef:
    kind: OCIRepository
    name: envoy-gateway
    namespace: flux-system
  install:
    remediation:
      retries: 3
    crds: CreateReplace
  upgrade:
    remediation:
      retries: 3
    crds: CreateReplace
  values:
    # HPA for control plane
    hpa:
      enabled: true
      minReplicas: 2
      maxReplicas: 10
      metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 50
            metrics: []
            behavior: {}
    # PDB for control plane
    podDisruptionBudget:
      maxUnavailable: 1
    # Resources for control plane
    deployment:
      envoyGateway:
        resources:
          requests:
            cpu: "20m"
            memory: "200Mi"
          limits:
            memory: "200Mi"